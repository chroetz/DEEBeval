---
title: "DEEB Evaluation -- Losses"
date: "`r format(Sys.Date())`"
output: 
  html_document:
    toc: yes
    toc_float: yes
    toc_depth: 6
    number_sections: yes
params:
  truthQuantsFile: "~/DEEBDB9/lotkaVolterra/Eval_Truth.csv"
  estiQuantsFiles: "~/DEEBDB9/lotkaVolterra/Eval_Trivial.csv"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(tidyverse.quiet = TRUE)
library(tidyverse)
```

```{r}
truth <- 
  read_csv(params$truthQuantsFile) |> 
  pivot_longer(-c(method, ends_with("Nr")), names_to="loss", values_to="refValue") |> 
  mutate(refValue = ifelse(refValue == 0, 1, refValue))
esti <- 
  map(params$estiQuantsFile, read_csv) |> 
  reduce(bind_rows) |> 
  pivot_longer(-c(method, ends_with("Nr")), names_to="loss")
data <- left_join(
  esti, 
  truth |> select(-method), 
  by = c("truthNr", "taskNr", "loss"))
```

```{r}
showTable <- function(d, caption) {
  nMethods <- length(unique(d$method))
  d |> 
    select(method, truthNr, value) |>
    pivot_wider(names_from = method, values_from = value) |> 
    kableExtra::kbl(
      digits = 3,
      caption = caption,
      booktabs = TRUE,
      align = c("l", "l", "l", rep("r", nMethods))
    ) |> 
    kableExtra::kable_styling(
      bootstrap_options = c("striped", "condensed"),
      latex_options = c("striped", "HOLD_position"),
      full_width = FALSE)
}
```

# Losses

```{r results='asis'}
for (tnr in unique(data$taskNr)) {
  cat("## Task", tnr, "\n")
  taskData <- filter(data, taskNr == tnr)
  for (lss in unique(taskData$loss)) {
    cat("### Loss", lss, "\n")
    lssData <- filter(taskData, loss == lss)
    for (onr in unique(lssData$obsNr)) {
      cat("#### ObsNr", onr, "\n")
      obsData <- filter(lssData, obsNr == onr)
      cat(showTable(
        obsData,
        paste0("Task ", tnr, ": ", lss, "-Loss (obsNr: ", onr, ")")))
    }
  }
}
```



